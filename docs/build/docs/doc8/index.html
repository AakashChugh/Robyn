<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<title data-react-helmet="true">Calibration using experimental results | Robyn</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Calibration using experimental results | Robyn"><meta data-react-helmet="true" name="description" content="Calibration concept"><meta data-react-helmet="true" property="og:description" content="Calibration concept"><meta data-react-helmet="true" property="og:url" content="https://facebookexperimental.github.io/Robyn//Robyn/docs/doc8"><link data-react-helmet="true" rel="shortcut icon" href="/Robyn/img/robyn_logo.png"><link data-react-helmet="true" rel="canonical" href="https://facebookexperimental.github.io/Robyn//Robyn/docs/doc8"><link rel="stylesheet" href="/Robyn/styles.68a92949.css">
<link rel="preload" href="/Robyn/styles.bfe6b70b.js" as="script">
<link rel="preload" href="/Robyn/runtime~main.85d3bc3b.js" as="script">
<link rel="preload" href="/Robyn/main.0871de4f.js" as="script">
<link rel="preload" href="/Robyn/1.825a405d.js" as="script">
<link rel="preload" href="/Robyn/2.ba15c381.js" as="script">
<link rel="preload" href="/Robyn/36.983e9ee2.js" as="script">
<link rel="preload" href="/Robyn/37.0034c13f.js" as="script">
<link rel="preload" href="/Robyn/f0959ab0.fe6279b5.js" as="script">
<link rel="preload" href="/Robyn/17896441.680f2216.js" as="script">
<link rel="preload" href="/Robyn/7c556f21.0d13fb99.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/Robyn/"><img class="navbar__logo" src="/Robyn/img/robyn_logo.png" alt="Robyn Logo"><strong class="navbar__title">Robyn</strong></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Robyn/docs/doc11">About Robyn</a><a href="https://github.com/facebookexperimental/Robyn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/Robyn/"><img class="navbar__logo" src="/Robyn/img/robyn_logo.png" alt="Robyn Logo"><strong class="navbar__title">Robyn</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/Robyn/docs/doc11">About Robyn</a></li><li class="menu__list-item"><a href="https://github.com/facebookexperimental/Robyn" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">How-to guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Robyn/docs/">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Robyn/docs/doc3">Quick Start</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/doc4">Ridge Regression</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/doc5">Variable Transformations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/doc6">Facebook Prophet - Trend, Seasonality and Holiday Effects</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/doc7">Automated hyperparameter selection and optimization</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/Robyn/docs/doc8">Calibration using experimental results</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/doc9">Outputs and diagnostics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/doc10">Getting help and contributing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/doc11">About Robyn</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Calibration using experimental results</h1></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="calibration-concept"></a>Calibration concept<a aria-hidden="true" tabindex="-1" class="hash-link" href="#calibration-concept" title="Direct link to heading">#</a></h3><p>By applying results from randomized controlled-experiments, you may improve the accuracy of your marketing mix models dramatically. It is recommended to run these on a recurrent basis to keep the model calibrated permanently. In general, we want to compare the experiment result with the MMM estimation of a marketing channel. Conceptually, this method is like a Bayesian method, in which we use experiment results as a prior to shrink the coefficients of media variables. A good example of these types of experiments is Facebookâ€™s conversion lift tool which can help guide the model towards a specific range of incremental values.</p><img alt="Calibration chart" src="/Robyn/img/calibration1.png"><p>Figure illustrates the calibration process above for one MMM candidate model.
Table below illustrates the model selection output including FB lift calibration element. Modelers can select the top models with relatively small MAPE metrics as the candidates for the final model. In this example, we suggest picking model two, as it has the minimum <em>MAPE(cal,fb)</em> and its <em>MAPE(holdout)</em> is only 0.4% more than the minimum one.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="example-table"></a>Example Table<a aria-hidden="true" tabindex="-1" class="hash-link" href="#example-table" title="Direct link to heading">#</a></h4><p>Sample output of model selection of a MMM with only two media channels, TV and Social</p><img alt="Calibration table" src="/Robyn/img/calibration2.png"><p>Note that <em>MAPE(cal,fb)</em> will likely vary more widely than <em>MAPE(holdout)</em> . Given this, calibration can improve performance without substantially sacrificing backtesting performance.
This calibration method can be applied to other media channels which run experiments, the more channels that are calibrated, the more accurate the MMM model. <em>You may find the calibration function in the â€˜func.Râ€™ script.</em></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="calibration-in-the-code"></a>Calibration in the code<a aria-hidden="true" tabindex="-1" class="hash-link" href="#calibration-in-the-code" title="Direct link to heading">#</a></h3><p>So, how do we apply this in our code?</p><ol><li>First, we check if media channels to be calibrated actually have a media variable created.</li><li>After that, we collect all different media to be calibrated. Consequently, we loop over each lift channel (Where for each of them we iterate over all different studies if more than one, determining the date range of each study)</li><li>In addition, we convert data from weeks to days (Please note the *7 in the formula for mmmDays, this is assuming you will use weekly data as a basis for your model).</li><li>Finally, and once both lift study and MMM dates are both in days, we scale the total decomposed model predicted sales into the exact number of days the lift study had to be comparable with previously uploaded liftAbs number under the set_lift variable (remember liftAbs values in set_lift variable have to be absolute and measuring the same metric as the model does ie. total incremental sales vs. model predicted sales)</li></ol><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#### Define lift calibration function</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">f.calibrateLift &lt;- function(decompCollect, set_lift) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  check_set_lift &lt;- any(sapply(set_lift$channel, function(x) any(str_detect(x, set_mediaVarName)))==F) #check if any lift channel doesn&#x27;t have media var</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (check_set_lift) {stop(&quot;set_lift channels must have media variable&quot;)}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ## prep lift input  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  getLiftMedia &lt;- unique(set_lift$channel)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  getDecompVec &lt;- decompCollect$xDecompVec</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ## loop all lift input</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  liftCollect &lt;- list()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  for (m in 1:length(getLiftMedia)) { # loop per lift channel</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    liftWhich &lt;- str_which(set_lift$channel, getLiftMedia[m])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    liftCollect2 &lt;- list()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (lw in 1:length(liftWhich)) { # loop per lift test per channel</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ## get lift period subset</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftStart &lt;- set_lift[liftWhich[lw], liftStartDate]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftEnd &lt;- set_lift[liftWhich[lw], liftEndDate]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftPeriodVec &lt;- getDecompVec[DS &gt;= liftStart &amp; DS &lt;= liftEnd, c(&quot;DS&quot;, getLiftMedia[m]), with = F]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ## scale decomp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      mmmDays &lt;- nrow(liftPeriodVec) * 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftDays &lt;- as.integer(liftEnd- liftStart + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      y_hatLift &lt;- sum(unlist(getDecompVec[, -1])) # total pred sales</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      x_decompLift &lt;- sum(liftPeriodVec[,2])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      x_decompLiftScaled &lt;- x_decompLift / mmmDays * liftDays</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ## output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftCollect2[[lw]] &lt;- data.table(liftMedia = getLiftMedia[m] ,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       liftStart = liftStart,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       liftEnd = liftEnd,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       liftAbs = set_lift[liftWhich[lw], liftAbs],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       decompAbsScaled = x_decompLiftScaled)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    liftCollect[[m]] &lt;- rbindlist(liftCollect2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div></div></div><p>The last step is to calculate the MAPE. This will be the key metric to define the model that is closest to actual incremental sales during periods for the lift study. It will therefore allow us to make a decision as per the example on the <a href="#example-table"><strong>table</strong></a>.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ## get mape_lift</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  liftCollect &lt;- rbindlist(liftCollect)[, mape_lift := abs((decompAbsScaled - liftAbs) / liftAbs) * 100]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return(liftCollect)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebookexperimental/Robyn/docs/doc8.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Robyn/docs/doc7"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Automated hyperparameter selection and optimization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Robyn/docs/doc9"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Outputs and diagnostics Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3klQ"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#calibration-concept" class="table-of-contents__link">Calibration concept</a></li><li><a href="#calibration-in-the-code" class="table-of-contents__link">Calibration in the code</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebookexperimental/Robyn" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/Robyn/img/oss_logo.png"></a></div><div>Copyright Â© 2020 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/Robyn/styles.bfe6b70b.js"></script>
<script src="/Robyn/runtime~main.85d3bc3b.js"></script>
<script src="/Robyn/main.0871de4f.js"></script>
<script src="/Robyn/1.825a405d.js"></script>
<script src="/Robyn/2.ba15c381.js"></script>
<script src="/Robyn/36.983e9ee2.js"></script>
<script src="/Robyn/37.0034c13f.js"></script>
<script src="/Robyn/f0959ab0.fe6279b5.js"></script>
<script src="/Robyn/17896441.680f2216.js"></script>
<script src="/Robyn/7c556f21.0d13fb99.js"></script>
</body>
</html>